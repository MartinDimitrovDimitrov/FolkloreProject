<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Folktales Browser</title>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <style>
      body {
        font-family: Arial, Helvetica, sans-serif; 
        margin: 25px; 
        line-height: 1.5;
      }

      #selected-panel { 
        border:1px solid #ccc; 
        padding: 12px; 
        margin-top: 20px;
      }

      #selected-panel h3 { 
        margin-top:0; 
      }

      #style-controls {
        margin-top: 10px; 
        display: none;
      }

      .btn {
        padding: 4px 8px;
        border: 1px solid #444;
        background: #eee;
        cursor: pointer;
        margin-right: 8px;
        font-size: 14px;
        border-radius: 4px;
        transition: background 0.2s, box-shadow 0.2s;
      }

      .btn:hover {
        background: #ddd;
      }

      .btn:focus-visible {
        outline: 2px solid #004488;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(0, 68, 136, 0.3);
      }

      .legend-placeholder {
        border: 2px dashed #ccc;
        height: 40px;
        background: #f9f9f9;
      }

      #legend {
        margin-top: 20px; 
        border: 1px solid #ccc; 
        padding: 10px;
      }

      #legend-list {
        list-style: none; 
        padding: 0;
      }

      #add-pin-style {
        margin-top: 10px; 
        border-top: 1px solid #ccc; 
        padding-top: 10px;
      }

      .drag-handle {
      cursor: grab;
      user-select: none;
      color: #666;
      font-weight: bold;
      }

      .drag-handle:hover {
      color: #000;
      }

      #filters-list {
      display: block;
      margin-top: 12px;
      }

      .filter-block {
      display: block;
      margin-top: 10px;
      }

      #filters-container {
        margin-top:20px; 
        margin-bottom:20px;
      }
      
      #map-container {
        margin-top:30px;
      }

      #map {
        height: 500px; 
        border: 1px solid #ccc;
      }

      .dataTable tbody tr {
        border-bottom: 1px solid #ddd;
      }

      .dataTable tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
    </style>
</head>
<body>
  <main>
    <h1>Folktales</h1>

    <div id="filters-container">
      <label style="display:block; margin-top: 10px; margin-bottom: 10px;">
      <input type="checkbox" id="show-only-selected">
      Show only selected tales
      </label>

      <button id="add-filter" class="btn">+ Add Filter</button>
      <div id="filters-list"></div>
    </div>

    <table id="tales-table" class="display stripe">
      <thead>
        <tr>
          <th>#</th> <!-- Row number -->
          <th><input type="checkbox" id="select-all-visible"></th>
          <th>Title</th>
          <th>Culture Group</th>
          <th>Collector</th>
          <th>Year</th>
          <th>Source</th>
          <th>Link</th>
          <th>Notes</th>
        </tr>
      </thead>

      <tbody>
        {% for t in tales %}
        <tr>
        <td></td>  <!-- ← This will be filled with the row number -->
        <td>
          <input type="checkbox"
                class="row-check"
                data-taleid="{{ t.tale_id }}"
                data-title="{{ t.title }}"
                data-culture="{{ t.culture_group }}"
                data-collector="{{ t.collector }}"
                data-year="{{ t.year_collected }}"
                data-source="{{ t.source }}"
                data-link="{{ t.link }}"
                data-notes="{{ t.notes }}"
                data-lat="{{ t.lat }}"
                data-lon="{{ t.lon }}"
                data-location="{{ t.location_name }}">
        </td>
        <td><a href="/tale/{{ t.tale_id }}" target="_blank" rel="noopener noreferrer">{{ t.title }}</a></td>
        <td>{{ t.culture_group or "(Not provided)"}}</td>
        <td>{{ t.collector or "(Not provided)"}}</td>
        <td>{{ t.year_collected or "(Not provided)"}}</td>
        <td>
          {% if t.source_title %}
            {{ t.source_title }}{% if t.source_page %}, p. {{ t.source_page }}{% endif %}
          {% else %}
            (Not provided)
          {% endif %}
        </td>
        <td>
          {% if t.source_link %}
            <a href="{{ t.source_link }}" title="Open source in a new tab" target="_blank" rel="noopener noreferrer nofollow">View Source</a>
          {% else %} 
            (Not provided)
          {% endif %}
        </td>
        <td>{{ t.notes or "(Not provided)"}}</td>
      </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Selected tales panel -->
    <div id="selected-panel">
      <h3 style="margin-top:0;">Selected Tales</h3>
      <p><b id="sel-count">0</b> tale(s) selected
        <button id="unselect-all" class="btn">Unselect All</button>
      </p>
        
      <div id="sel-info">(no tales selected)</div>

      <!-- Style Controls -->
      <div id="style-controls">
        <label for="pin-color">Color: </label>
        <select id="pin-color">
          <option value="blue">Blue</option>
          <option value="red">Red</option>
          <option value="green">Green</option>
          <option value="orange">Orange</option>
          <option value="purple">Purple</option>
          <option value="brown">Brown</option>
          <option value="black">Black</option>
          <option value="gray">Gray</option>
        </select>

        <label for="pin-shape" style="margin-left: 10px;">Shape: </label>
        <select id="pin-shape">
          <option value="circle">Circle</option>
          <option value="square">Square</option>
          <option value="triangle">Triangle</option>
          <option value="star">Star</option>
        </select>

        <div style="margin-top: 10px;">
            <button id="add-map" class="btn">Add to Map</button>
            <button id="remove-map" class="btn">Remove from Map</button>
        </div>
      </div>
    </div>

    <!-- Map container -->
    <div id="map-container">
      <h2>Map</h2>
      <div style="margin-top: 10px; margin-bottom: 12px;">
        <button id="clear-map" class="btn">Clear Map</button>
        <button id="select-map" class="btn">Select All on Map</button>
      </div>
      <div id="map"></div>
    </div>

    <div id="legend">
      <h3>Legend</h3>
      <button id="clear-legend" class="btn">Clear Legend</button>
      <small style="color:#666; margin-bottom: 10px; margin-top: 10px; display: block;">
        Drag <span style="font-weight:bold;">≡</span> to reorder styles. Deleting a style is possible only if it is not used on the map.
      </small>
      <ul id="legend-list"></ul>
        <div id="add-pin-style">
          <h4>Add New Pin Style</h4>
          <label for="new-pin-color">Color:</label>
          <select id="new-pin-color">
            <option value="blue">Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="purple">Purple</option>
            <option value="brown">Brown</option>
            <option value="black">Black</option>
            <option value="gray">Gray</option>
          </select>

          <label for="new-pin-shape" style="margin-left:10px;">Shape:</label>
          <select id="new-pin-shape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="star">Star</option>
          </select>

          <button id="add-new-style" class="btn">Add</button>
      </div>
    </div>
  </main>

<!-- Leaflet CSS/JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>

<script src="static/folktales.js"></script>

</body>
</html>